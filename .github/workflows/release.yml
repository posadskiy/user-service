name: Release

on:
  push:
    branches:
      - main
      - develop

env:
  JAVA_VERSION: '21'

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Extract version from tag or commit message
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          # Extract from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          TAG_NAME=$GITHUB_REF_NAME
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "trigger_type=tag" >> $GITHUB_OUTPUT
        else
          # Extract from commit message
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          
          # Look for version patterns in commit message
          if [[ $COMMIT_MSG =~ v([0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?) ]]; then
            VERSION="${BASH_REMATCH[1]}"
            TAG_NAME="v$VERSION"
            echo "Found version: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "trigger_type=commit" >> $GITHUB_OUTPUT
          else
            echo "No valid version pattern found in commit message: $COMMIT_MSG"
            echo "Expected format: v1.0.0, v2.1.3, v1.0.0-beta, etc."
            echo "Skipping release creation"
            exit 0
          fi
        fi
        
    - name: Create Release
      if: steps.version.outputs.version != ''
      env:
        GH_TOKEN: ${{ secrets.DEPLOYMENT_GITHUB_TOKEN }}
      run: |
        # Fetch all tags to ensure they're available
        git fetch --tags
        
        # Get the previous tag to determine commit range
        CURRENT_VERSION="${{ steps.version.outputs.version }}"
        
        # More robust approach to find previous tag
        PREVIOUS_TAG=$(git tag --sort=-version:refname | while read tag; do
          if [[ "$tag" != "v$CURRENT_VERSION" ]]; then
            echo "$tag"
            break
          fi
        done)
        
        # Use the previous tag for the commit range
        COMMIT_RANGE="$PREVIOUS_TAG..HEAD"
        
        # Create release body header
        echo "## User Service Release ${{ steps.version.outputs.version }}" > release_body.md
        echo "" >> release_body.md
        echo "### 📝 Changes" >> release_body.md
        
        if [[ -n "$PREVIOUS_TAG" ]]; then
          # Get all commit messages in the range, excluding all version bump commits
          COMMITS=$(git log --pretty=format:"- %s" $COMMIT_RANGE | grep -v "^- v[0-9]" || echo "")
          if [[ -z "$COMMITS" ]]; then
            echo "No changes since previous release." >> release_body.md
          else
            echo "$COMMITS" >> release_body.md
          fi
        else
          # First release - include all commits except version bump commits
          COMMITS=$(git log --pretty=format:"- %s" | grep -v "^- v[0-9]" || echo "")
          if [[ -z "$COMMITS" ]]; then
            echo "No changes since previous release." >> release_body.md
          else
            echo "$COMMITS" >> release_body.md
          fi
        fi
        
        # Add footer to release notes
        echo "" >> release_body.md
        echo "### 📦 Release Artifacts" >> release_body.md
        echo "- Source code tagged with version ${{ steps.version.outputs.version }}" >> release_body.md
        echo "- Maven artifacts available in GitHub Packages" >> release_body.md
        echo "" >> release_body.md
        echo "### 🔧 Build Instructions" >> release_body.md
        echo '```bash' >> release_body.md
        echo "mvn clean package -DskipTests" >> release_body.md
        echo "java -jar user-service-web/target/user-service-web-*.jar" >> release_body.md
        echo '```' >> release_body.md
        echo "" >> release_body.md
        echo "### 📝 Release Trigger" >> release_body.md
        if [[ "${{ steps.version.outputs.trigger_type }}" == "commit" ]]; then
          echo "This release was triggered by a commit message with version pattern." >> release_body.md
        else
          echo "This release was triggered by a git tag push." >> release_body.md
        fi
        
        # Create release using GitHub CLI
        gh release create ${{ steps.version.outputs.tag }} \
          --title "User Service ${{ steps.version.outputs.version }}" \
          --notes-file release_body.md \
          --draft=false \
          --prerelease=false

  deploy-to-packages:
    name: Deploy to GitHub Packages
    runs-on: ubuntu-latest
    needs: create-release
    if: needs.create-release.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Extract version from tag or commit message
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ $COMMIT_MSG =~ v([0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?) ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            echo "No valid version pattern found in commit message: $COMMIT_MSG"
            echo "Expected format: v1.0.0, v2.1.3, v1.0.0-beta, etc."
            echo "Skipping deployment"
            exit 0
          fi
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      if: steps.version.outputs.version != ''
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: Cache Maven packages
      if: steps.version.outputs.version != ''
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Clean up old packages (keep only 3 latest versions)
      if: steps.version.outputs.version != ''
      run: |
        # Get all package versions and sort them by version number
        # Keep only the 3 most recent versions
        echo "Cleaning up old packages, keeping only 3 latest versions..."
        
        # Get all package versions from GitHub Packages API
        PACKAGES=$(gh api repos/${{ github.repository }}/packages --jq '.[] | select(.package_type == "maven") | .name' | sort -u)
        
        if [ -z "$PACKAGES" ]; then
          echo "No Maven packages found in repository"
          exit 0
        fi
        
        for PACKAGE in $PACKAGES; do
          echo "Processing package: $PACKAGE"
          
          # Get all versions for this package, sorted by version (newest first)
          VERSIONS=$(gh api repos/${{ github.repository }}/packages/maven/$PACKAGE/versions \
            --jq '.[] | .name' | sort -V -r)
          
          if [ -z "$VERSIONS" ]; then
            echo "No versions found for package $PACKAGE"
            continue
          fi
          
          # Count total versions
          TOTAL_VERSIONS=$(echo "$VERSIONS" | wc -l)
          echo "Total versions for $PACKAGE: $TOTAL_VERSIONS"
          
          if [ "$TOTAL_VERSIONS" -gt 3 ]; then
            # Get versions to delete (skip first 3)
            VERSIONS_TO_DELETE=$(echo "$VERSIONS" | tail -n +4)
            
            echo "Versions to delete for $PACKAGE:"
            echo "$VERSIONS_TO_DELETE"
            
            # Delete old versions
            for VERSION in $VERSIONS_TO_DELETE; do
              echo "Deleting version $VERSION of package $PACKAGE"
              # Get the version ID first, then delete by ID
              VERSION_ID=$(gh api repos/${{ github.repository }}/packages/maven/$PACKAGE/versions \
                --jq ".[] | select(.name == \"$VERSION\") | .id")
              
              if [ -n "$VERSION_ID" ]; then
                gh api repos/${{ github.repository }}/packages/maven/$PACKAGE/versions/$VERSION_ID \
                  --method DELETE || echo "Failed to delete version $VERSION (ID: $VERSION_ID)"
              else
                echo "Version $VERSION not found for package $PACKAGE"
              fi
            done
          else
            echo "Package $PACKAGE has $TOTAL_VERSIONS versions (≤3), no cleanup needed"
          fi
        done
      env:
        GH_TOKEN: ${{ secrets.DEPLOYMENT_GITHUB_TOKEN }}
        
    - name: Build and Publish to GitHub Packages
      if: steps.version.outputs.version != ''
      run: |
        # Set version in pom.xml files
        mvn versions:set -DnewVersion=${{ steps.version.outputs.version }}
        
        # Build and publish all modules
        mvn clean deploy \
          -DskipTests \
          -Dmaven.test.skip=true \
          -DaltDeploymentRepository=github::https://maven.pkg.github.com/${{ github.repository }}
      env:
        GITHUB_TOKEN: ${{ secrets.DEPLOYMENT_GITHUB_TOKEN }}
        
    - name: Upload JAR artifacts
      if: steps.version.outputs.version != ''
      uses: actions/upload-artifact@v4
      with:
        name: user-service-jars
        path: |
          user-service-web/target/*.jar
          user-service-core/target/*.jar
          user-service-api/target/*.jar
        retention-days: 30 